import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import io
import base64

# Ensure backend doesn't try to open GUI window
plt.switch_backend('Agg')

async def display_vulnerability_pie_chart(records):
    # Convert MongoDB records to DataFrame
    df = pd.DataFrame(records)

    # Keep latest record per asset (IP + Port)
    df['datetime'] = pd.to_datetime(df['Plugin Modification Date'], errors='coerce')
    df = df.dropna(subset=['datetime'])

    df['asset_id'] = df['IP Address'].astype(str) + ":" + df['Port'].astype(str)
    latest_df = df.sort_values('datetime').groupby('asset_id').tail(1)

    # Group by severity
    severity_counts = latest_df['Severity'].value_counts()

    # Plot pie chart
    fig, ax = plt.subplots()
    colors = sns.color_palette('pastel')[0:len(severity_counts)]
    ax.pie(severity_counts, labels=severity_counts.index, colors=colors, autopct='%1.1f%%')
    ax.set_title("Vulnerabilities by Severity")

    # Save image to buffer and convert to base64
    buffer = io.BytesIO()
    plt.savefig(buffer, format='png')
    buffer.seek(0)
    image_base64 = base64.b64encode(buffer.read()).decode('utf-8')
    buffer.close()

    # Return base64 image to frontend
    return {
        "type": "image",
        "title": "Vulnerability Severity Distribution",
        "image_base64": image_base64
    }
